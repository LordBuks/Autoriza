<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Primeiro Acesso - Sistema de Autorizações Digitais</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    body {
      position: relative;
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.9));
    }

    .background-container {
      position: fixed;
      width: 90%;
      max-width: 800px;
      height: 100vh;
      left: 50%;
      transform: translateX(-50%);
      z-index: -1;
      background: url('content.png') center/cover;
      filter: blur(2px);
    }

    .header {
      width: 90%;
      max-width: 800px;
      margin: 2rem auto;
      text-align: center;
      padding: 1rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .main-container {
      width: 90%;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 2rem;
      margin: 1rem 0;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-control {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 0.5rem;
    }

    .btn-primary {
      background: #e63946;
      color: white;
      padding: 1rem;
      border: none;
      border-radius: 6px;
      width: 100%;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.3s;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .header-logo {
      max-width: 150px;
      margin-bottom: 1rem;
    }

    .alert-danger, .alert-success {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      display: none;
    }

    .alert-danger {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }

    .alert-success {
      color: #155724;
      background-color: #d4edda;
      border-color: #c3e6cb;
    }

    .password-requirements {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 0.5rem;
    }

    @media (max-width: 768px) {
      .header, .main-container {
        width: 95%;
      }
      
      .card {
        padding: 1.5rem;
      }
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <div class="background-container"></div>

  <header class="header">
    <img src="https://i.imgur.com/odzcc03.png" alt="Logo SC Internacional" class="header-logo">
    <h1 class="header-title">Sistema de Autorizações Digitais</h1>
  </header>

  <div class="main-container">
    <div class="card">
      <h2 class="card-title">Configuração de Senha - Primeiro Acesso</h2>
      
      <div id="alert-message" class="alert-danger"></div>
      <div id="success-message" class="alert-success"></div>
      
      <p>Bem-vindo ao seu primeiro acesso! Por favor, configure sua senha personalizada para continuar.</p>
      
      <form id="password-form">
        <div class="form-group">
          <label for="new-password" class="form-label">Nova Senha</label>
          <input type="password" id="new-password" name="new-password" class="form-control" placeholder="Digite sua nova senha" required>
          <div class="password-requirements">
            A senha deve ter pelo menos 6 caracteres.
          </div>
        </div>
        
        <div class="form-group">
          <label for="confirm-password" class="form-label">Confirmar Senha</label>
          <input type="password" id="confirm-password" name="confirm-password" class="form-control" placeholder="Confirme sua nova senha" required>
        </div>
        
        <button type="submit" class="btn-primary">Salvar Senha</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const passwordForm = document.getElementById('password-form');
      const alertMessage = document.getElementById('alert-message');
      const successMessage = document.getElementById('success-message');

      // Verificar se o serviço Firebase está pronto e se há um usuário logado
      // O firebase-config.js já deve ter sido carregado
      if (!window.firebaseService || !window.firebaseService.auth) {
          console.error("Firebase Service não inicializado a tempo.");
          // Poderia tentar esperar um pouco ou mostrar erro permanente
          showAlert('Erro na inicialização. Recarregue a página ou contate o suporte.', 'danger');
          return;
      }

      // Esperar o estado de autenticação ser resolvido
      window.firebaseService.auth.onAuthStateChanged(user => {
          if (user) {
              // Usuário está logado, podemos prosseguir
              console.log("Usuário autenticado:", user.uid);
              // Verificar se veio do fluxo de primeiro acesso (opcional, mas bom ter)
              const tempProfileFlag = localStorage.getItem('temp_profile'); // Ainda usamos como flag
              if (!tempProfileFlag) {
                  console.warn("Flag temp_profile não encontrada. Considerado acesso normal pós-login.");
                  // Não redirecionar, permitir que definam senha se quiserem (ou ajustar regra de negócio)
              }

          } else {
              // Usuário não está logado. Redirecionar para login.
              console.error("Usuário não autenticado na página de primeiro acesso.");
              showAlert('Sessão expirada ou inválida. Redirecionando para o login...', 'danger');
              setTimeout(() => { window.location.href = 'index.html'; }, 3000);
              return; // Importante sair para não adicionar listener abaixo
          }

          // Adicionar listener apenas se o usuário estiver autenticado
          passwordForm.addEventListener('submit', function(e) {
              e.preventDefault();

              const newPassword = document.getElementById('new-password').value;
              const confirmPassword = document.getElementById('confirm-password').value;

              // Validar senha
              if (newPassword.length < 6) {
                  showAlert('A senha deve ter pelo menos 6 caracteres.', 'danger');
                  return;
              }

              // Verificar se as senhas coincidem
              if (newPassword !== confirmPassword) {
                  showAlert('As senhas não coincidem. Por favor, tente novamente.', 'danger');
                  return;
              }

              // Obter usuário atual (já verificado acima)
              const currentUser = window.firebaseService.auth.currentUser;
              const userId = currentUser.uid; // Usar UID como ID do documento no Firestore

              // 1. Atualizar Senha no Firebase Auth
              currentUser.updatePassword(newPassword).then(() => {
                  console.log("Senha atualizada no Firebase Auth para usuário:", userId);

                  // 2. Atualizar documento no Firestore (coleção 'usuarios')
                  const userProfileUpdate = {
                      passwordSet: true,
                      passwordSetDate: new Date().toISOString()
                      // Adicionar outros campos se necessário, ex: dataPrimeiroAcesso: new Date().toISOString()
                  };

                  window.firebaseService.atualizarDocumento('usuarios', userId, userProfileUpdate)
                      .then(result => {
                          if (result.sucesso) {
                              console.log("Perfil atualizado no Firestore para usuário:", userId);
                              showAlert('Senha configurada com sucesso! Redirecionando para o login...', 'success');
                              localStorage.removeItem('temp_profile'); // Limpar a flag temporária
                              setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                          } else {
                              // Erro ao atualizar Firestore, mas senha Auth foi atualizada.
                              console.error("Erro ao atualizar perfil no Firestore:", result.erro);
                              // Informar usuário, talvez pedir para tentar novamente ou contatar suporte
                              // A senha JÁ foi alterada no Auth.
                              showAlert('Senha atualizada, mas houve um erro ao salvar os detalhes do perfil. Faça login com a nova senha. Se o problema persistir, contate o suporte.', 'warning');
                              localStorage.removeItem('temp_profile'); // Limpar a flag mesmo assim? Sim.
                              setTimeout(() => { window.location.href = 'index.html'; }, 5000); // Redirecionar mesmo com erro parcial
                          }
                      })
                      .catch(error => {
                           // Erro catastrófico na chamada do Firestore
                           console.error("Erro (catch) ao atualizar perfil no Firestore:", error);
                           showAlert('Senha atualizada, mas houve um erro crítico ao salvar os detalhes do perfil. Faça login com a nova senha. Se o problema persistir, contate o suporte.', 'warning');
                           localStorage.removeItem('temp_profile');
                           setTimeout(() => { window.location.href = 'index.html'; }, 5000);
                      });

              }).catch((error) => {
                  // Erro ao atualizar senha no Firebase Auth
                  console.error("Erro ao atualizar senha no Firebase Auth:", error);
                  let errorMessage = 'Erro ao atualizar senha. ';
                  if (error.code === 'auth/requires-recent-login') {
                      errorMessage += 'Por segurança, sua sessão expirou. Faça login novamente antes de tentar definir a senha.';
                      // Redirecionar para login
                       setTimeout(() => { window.location.href = 'index.html'; }, 5000);
                  } else if (error.code === 'auth/weak-password') {
                      errorMessage += 'A senha fornecida é muito fraca.';
                  }
                   else {
                      errorMessage += 'Código: ' + error.code; // Incluir código para debug
                  }
                  showAlert(errorMessage, 'danger');
              });
          }); // Fim do event listener do form

      }); // Fim do onAuthStateChanged


      // Função showAlert permanece a mesma
      function showAlert(message, type) {
        if (type === 'danger') {
          alertMessage.textContent = message;
          alertMessage.style.display = 'block';
          successMessage.style.display = 'none';

          // Esconder a mensagem após 7 segundos
          setTimeout(function() {
            alertMessage.style.display = 'none';
          }, 7000); 
        } else if (type === 'success' || type === 'warning') { // Adicionar warning
          const targetMessage = (type === 'success') ? successMessage : alertMessage; 
          if (type === 'warning') {
              alertMessage.className = 'alert alert-warning'; // Usar classe para estilo
              alertMessage.style.backgroundColor = '#fff3cd'; 
              alertMessage.style.color = '#856404';
              alertMessage.style.borderColor = '#ffeeba';
          } else {
               successMessage.className = 'alert alert-success'; 
               successMessage.style.display = 'block'; // Garantir que success esteja visível
               alertMessage.style.display = 'none'; // Esconder alerta de erro/warning
          }

          targetMessage.textContent = message;
          targetMessage.style.display = 'block';
          // Esconder a outra mensagem se necessário
          if (targetMessage === successMessage) alertMessage.style.display = 'none';
          else successMessage.style.display = 'none';

        }
      }
    });
  </script>
  <!-- Firebase Config -->
  <script src="js/firebase-config.js"></script>
</body>
</html>
